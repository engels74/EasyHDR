repos:
  - repo: local
    hooks:
      # ── Commit-stage hooks ──────────────────────────────────────────────
      - id: trailing-whitespace
        name: Trim Trailing Whitespace
        entry: perl -pi -e 's/[^\S\n\r]+$//'
        language: system
        types: [text]

      - id: end-of-file-fixer
        name: Fix End of Files
        entry: bash -c 'for f in "$@"; do [ -s "$f" ] && [ -n "$(tail -c1 "$f")" ] && echo >> "$f"; done; exit 0'
        language: system
        types: [text]

      - id: check-yaml
        name: Check YAML
        entry: uv run --with pyyaml python3 -c "import sys, yaml; yaml.safe_load(open(sys.argv[1]))"
        language: system
        types: [yaml]

      - id: check-toml
        name: Check TOML
        entry: uv run python3 -c "import sys, tomllib; tomllib.load(open(sys.argv[1],'rb'))"
        language: system
        types: [toml]

      - id: check-merge-conflict
        name: Check Merge Conflicts
        entry: bash -c 'for f in "$@"; do if grep -En "^(<{7}|>{7}|={7})(\s|$)" "$f"; then echo "Merge conflict found in $f"; exit 1; fi; done'
        language: system
        types: [text]

      - id: detect-private-key
        name: Detect Private Keys
        entry: bash -c 'for f in "$@"; do if grep -El "-----BEGIN (RSA |DSA |EC |PGP |OPENSSH )?PRIVATE KEY" "$f"; then echo "Private key found in $f"; exit 1; fi; done'
        language: system
        types: [text]

      - id: no-commit-to-branch
        name: No Commit to Branch
        entry: bash -c 'branch=$(git rev-parse --abbrev-ref HEAD); [ "$branch" != "main" ] && [ "$branch" != "master" ]'
        language: system
        pass_filenames: false
        stages: [pre-commit]

      - id: check-added-large-files
        name: Check Added Large Files
        entry: bash -c 'for f in "$@"; do size=$(wc -c < "$f"); [ "$size" -gt 2097152 ] && echo "$f is too large ($size bytes)" && exit 1; done; exit 0'
        language: system

      - id: cargo-fmt
        name: Cargo Fmt
        entry: cargo fmt --all -- --check
        language: system
        pass_filenames: false
        types: [rust]

      - id: cargo-clippy
        name: Cargo Clippy
        entry: bash -c 'if [ "$OS" = "Windows_NT" ]; then cargo clippy --all-targets --all-features -- -D warnings; else cargo xwin clippy --target x86_64-pc-windows-msvc --all-targets --all-features -- -D warnings; fi'
        language: system
        pass_filenames: false
        types: [rust]

      # ── Push-stage hooks ────────────────────────────────────────────────
      - id: cargo-test
        name: Cargo Test
        entry: bash -c 'if [ "$OS" = "Windows_NT" ]; then cargo test --lib; else cargo xwin check --lib --target x86_64-pc-windows-msvc; fi'
        language: system
        pass_filenames: false
        stages: [pre-push]
