---
name: Miri

"on":
  push:
    branches:
      - '**'
  pull_request:
    branches:
      - '**'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  miri-portable:
    name: Miri Portable Code (Strict)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Rust nightly with Miri
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: nightly
          components: miri
          cache: true

      - name: Run Miri on portable code (config, error modules)
        run: |
          cargo miri test --lib config -- --test-threads=1
          cargo miri test --lib error -- --test-threads=1
        env:
          MIRIFLAGS: -Zmiri-disable-isolation -Zmiri-strict-provenance -Zmiri-symbolic-alignment-check
        # --test-threads=1 is used for Miri to ensure deterministic execution and better UB detection
        # This is a Miri-specific requirement, not related to test isolation
        # No continue-on-error: These tests should pass and will fail CI if UB is detected

  miri-full:
    name: Miri Full Coverage (Best Effort)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Rust nightly with Miri
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: nightly
          components: miri
          cache: true

      - name: Run Miri on all library tests
        run: cargo miri test --lib -- --test-threads=1
        env:
          MIRIFLAGS: -Zmiri-disable-isolation
        continue-on-error: true
        # --test-threads=1 is used for Miri to ensure deterministic execution and better UB detection
        # This is a Miri-specific requirement, not related to test isolation
        # Continue-on-error: Windows FFI calls will fail on Linux Miri
        # but this still validates pure Rust code in other modules

      - name: Run Miri with strict checking on all tests
        run: cargo miri test --lib -- --test-threads=1
        env:
          MIRIFLAGS: -Zmiri-disable-isolation -Zmiri-strict-provenance -Zmiri-symbolic-alignment-check
        continue-on-error: true
        # --test-threads=1 is used for Miri to ensure deterministic execution and better UB detection
        # Strict mode catches additional provenance and alignment issues
